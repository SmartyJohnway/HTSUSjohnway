<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾åœ‹é‹¼é‹åŠç¨…å‰‡æŸ¥è©¢ç³»çµ± (æ•´åˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ç¾åœ‹é‹¼é‹åŠç¨…å‰‡æŸ¥è©¢ç³»çµ±</h1>
            <p class="text-gray-600 mt-2">æ•´åˆé—œç¨…è¦å‰‡æŸ¥è©¢èˆ‡å®˜æ–¹ HTSUS API è³‡æ–™åº«</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-2 md:space-x-6" aria-label="Tabs">
                <button id="tabQuery" class="tab-btn active whitespace-nowrap py-4 px-1 md:px-2 border-b-2 font-medium text-base md:text-lg">
                    é—œç¨…æŸ¥è©¢
                </button>
                <button id="tabHts" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 md:px-2 border-b-2 font-medium text-base md:text-lg">
                    HTSUS ç¨…å‰‡è³‡æ–™åº« (API)
                </button>
                <button id="tabSources" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 md:px-2 border-b-2 font-medium text-base md:text-lg">
                    å®˜æ–¹ä¾†æº
                </button>
            </nav>
        </div>

        <!-- Tab 1: Steel/Aluminum Tariff Content -->
        <div id="queryContent">
            <!-- Search and Filter Bar -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 sticky top-4 z-10">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="relative flex-grow">
                        <input type="text" id="searchInput" placeholder="è«‹å…ˆè¼‰å…¥è³‡æ–™..." class="w-full p-4 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow disabled:opacity-50" disabled>
                        <svg class="w-6 h-6 text-gray-400 absolute top-1/2 left-4 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                    </div>
                    <div class="flex items-center justify-center space-x-2 bg-gray-100 p-1 rounded-xl">
                        <button id="filterAll" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold shadow">å…¨éƒ¨</button>
                        <button id="filterSteel" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-semibold">é‹¼éµ</button>
                        <button id="filterAluminum" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-semibold">é‹</button>
                    </div>
                </div>
                <div id="app1Loader" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex flex-col sm:flex-row items-center gap-4">
                    <p id="app1Status" class="text-sm text-blue-700 flex-grow">
                        <span class="font-semibold">è¼‰å…¥ä¸­...</span> æ­£åœ¨è®€å–é—œç¨…è¦å‰‡è³‡æ–™ã€‚
                    </p>
                </div>
            </div>
            <main id="resultsContainer" class="space-y-4 mt-8"></main>
            <div id="noResults" class="hidden text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900">æ‰¾ä¸åˆ°çµæœ</h3>
                <p class="mt-1 text-sm text-gray-500">è«‹å˜—è©¦ä½¿ç”¨ä¸åŒçš„é—œéµå­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚</p>
            </div>
             <div id="app1Welcome" class="text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900">ç­‰å¾…è³‡æ–™</h3>
                <p class="mt-1 text-sm text-gray-500">è«‹é»æ“Šä¸Šæ–¹çš„ã€Œä¸Šå‚³ JSONã€æŒ‰éˆ•ä¾†è¼‰å…¥é—œç¨…è³‡æ–™ã€‚</p>
            </div>
        </div>

        <!-- Tab 2: HTSUS API Query Tool Content -->
        <div id="htsContent" class="hidden">
            <section class="bg-white border border-gray-200 rounded-xl p-4 md:p-5 mb-6 shadow-sm">
                 <div class="flex items-center gap-3">
                    <h2 class="text-lg font-semibold text-gray-900">è³‡æ–™ä¾†æº:</h2>
                    <a href="https://hts.usitc.gov/" target="_blank" class="text-sm text-blue-600 hover:underline">USITC Official API (via Netlify Proxy)</a>
                </div>
            </section>

            <div class="sticky top-4 z-10 bg-gray-100/80 backdrop-blur-sm p-2 rounded-xl mb-4">
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <input id="htsSearchInput" type="text" placeholder="è¼¸å…¥è‹±æ–‡é—œéµå­—æˆ– HTS ç¢¼ (e.g., copper, 0101.21.00)..." class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-4 pl-12 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-300" />
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                        </div>
                        <button id="htsSearchBtn" class="btn btn-primary px-6">æœå°‹</button>
                    </div>
                    <div class="flex items-center gap-2 px-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="show232Only" class="form-checkbox h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">åƒ…é¡¯ç¤º 232 æ¢æ¬¾ç›¸é—œé …ç›®</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="htsStatusContainer">
                <div id="htsLoader" class="hidden flex-col items-center justify-center text-center py-10">
                    <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-500">æ­£åœ¨é€éä»£ç†æŸ¥è©¢ USITC API è³‡æ–™...</p>
                </div>
                <div id="htsWelcomeMessage" class="text-center py-16">
                     <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.916 17.916 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">å³æ™‚ HTSUS æŸ¥è©¢</h3>
                    <p class="mt-1 text-sm text-gray-500">è«‹åœ¨ä¸Šæ–¹æœå°‹æ¡†è¼¸å…¥é—œéµå­—ï¼Œç›´æ¥æŸ¥è©¢ç¾åœ‹å®˜æ–¹ç¨…å‰‡è³‡æ–™åº«ã€‚</p>
                </div>
            </div>
            <div id="htsResultsContainer" class="space-y-3"></div>
        </div>

        <!-- Tab 3: Official Sources Content -->
        <div id="sourcesContent" class="hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">å®˜æ–¹è³‡æ–™åº«èˆ‡ä¸»è¦æ³•è¦</h2>
                     <a href="https://hts.usitc.gov/" target="_blank" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors mb-4">
                        <p class="font-semibold text-blue-600">ç¾åœ‹åœ‹éš›è²¿æ˜“å§”å“¡æœƒ (USITC) - HTSUS å®˜æ–¹æŸ¥è©¢ç¶²ç«™</p>
                        <p class="text-sm text-gray-600">æŸ¥è©¢æ‰€æœ‰é€²å£ç”¢å“HTSUSç¢¼ã€ç¨…ç‡åŠæ³•è¦çš„æœ€çµ‚æ¬Šå¨ä¾†æºã€‚ (ç›®å‰ç‰ˆæœ¬: 2025 HTS Revision 19)</p>
                    </a>
                    <a href="https://www.bis.doc.gov/index.php/232-steel" target="_blank" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <p class="font-semibold text-blue-600">å•†å‹™éƒ¨å·¥æ¥­èˆ‡å®‰å…¨å±€ (BIS) - é‹¼éµ232å°ˆé </p>
                        <p class="text-sm text-gray-600">æä¾›æ‰€æœ‰é—œæ–¼é‹¼éµ232æ¢æ¬¾çš„èƒŒæ™¯ã€æ³•è¦ã€å…¬å‘ŠåŠæ’é™¤ç¨‹åºçš„å®˜æ–¹å…¥å£ã€‚</p>
                    </a>
                    <a href="https://www.bis.doc.gov/index.php/232-aluminum" target="_blank" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors mt-4">
                        <p class="font-semibold text-blue-600">å•†å‹™éƒ¨å·¥æ¥­èˆ‡å®‰å…¨å±€ (BIS) - é‹232å°ˆé </p>
                        <p class="text-sm text-gray-600">æä¾›æ‰€æœ‰é—œæ–¼é‹232æ¢æ¬¾çš„èƒŒæ™¯ã€æ³•è¦ã€å…¬å‘ŠåŠæ’é™¤ç¨‹åºçš„å®˜æ–¹å…¥å£ã€‚</p>
                    </a>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">æœ€æ–°è¡ç”Ÿå“å…¬å‘Š (2025/08/18 ç”Ÿæ•ˆ)</h2>
                    <div class="space-y-4">
                        <a href="https://content.govdelivery.com/accounts/USDHSCBP/bulletins/3ee1cba" target="_blank" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"><p class="font-semibold text-blue-600">CBP é‹¼éµè¡ç”Ÿå“æŒ‡å¼• (CSMS #65936570)</p><p class="text-sm text-gray-600">ç¾åœ‹æµ·é—œæš¨é‚Šå¢ƒä¿è¡›å±€ç™¼å¸ƒçš„å®˜æ–¹æŒ‡å¼•ï¼Œè©³ç´°èªªæ˜æ–°å¢é‹¼éµè¡ç”Ÿå“çš„åŸ·è¡Œç´°ç¯€ã€‚</p></a>
                        <a href="https://content.govdelivery.com/bulletins/gd/USDHSCBP-3ee1ce7?wgt_ref=USDHSCBP_WIDGET_2" target="_blank" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"><p class="font-semibold text-blue-600">CBP é‹è¡ç”Ÿå“æŒ‡å¼• (CSMS #65936615)</p><p class="text-sm text-gray-600">ç¾åœ‹æµ·é—œæš¨é‚Šå¢ƒä¿è¡›å±€ç™¼å¸ƒçš„å®˜æ–¹æŒ‡å¼•ï¼Œè©³ç´°èªªæ˜æ–°å¢é‹è¡ç”Ÿå“çš„åŸ·è¡Œç´°ç¯€ã€‚</p></a>
                        <a href="https://www.federalregister.gov/documents/2025/08/19/2025-15819/adoption-and-procedures-of-the-section-232-steel-and-aluminum-tariff-inclusions-process" target="_blank" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"><p class="font-semibold text-blue-600">è¯é‚¦å…¬å ±å®˜æ–¹å…¬å‘Š</p><p class="text-sm text-gray-600">ç¾åœ‹æ”¿åºœåœ¨ã€Šè¯é‚¦å…¬å ±ã€‹ä¸Šç™¼å¸ƒçš„æ­£å¼æ³•å¾‹æ–‡ä»¶ï¼Œç¢ºèªæ–°å¢407é …è¡ç”Ÿå“æ¸…å–®ã€‚</p></a>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>è³‡æ–™ä¾†æºï¼šç¾åœ‹æµ·é—œæš¨é‚Šå¢ƒä¿è¡›å±€(CBP)åŠå•†å‹™éƒ¨(DOC)å…¬å‘Šï¼›HTSUSè³‡æ–™åº«ç”±USITC APIæä¾›ã€‚</p>
            <p class="mt-1">æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼Œæœ€çµ‚è§£é‡‹è«‹ä»¥ç¾åœ‹å®˜æ–¹å…¬å‘Šç‚ºæº–ã€‚</p>
            <p class="mt-1">è£½ä½œè€…: Johnway</p>
        </footer>
    </div>

    <script>
        // --- GLOBAL ELEMENTS & STATE ---
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = { 
            queryContent: document.getElementById('queryContent'), 
            htsContent: document.getElementById('htsContent'), 
            sourcesContent: document.getElementById('sourcesContent') 
        };
        // This is no longer needed for App 2 but might be used by App 1's hts-code-link logic
        let htsAllData = []; 

        // --- APP 1: STEEL/ALUMINUM TARIFFS (DATA-DRIVEN REFACTOR) ---
        function initializeApp1() {
            // --- App 1 State & DOM ---
            let tariffData = []; // Data is now loaded dynamically
            const searchInput = document.getElementById('searchInput');
            const resultsContainer = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const fileInput = document.getElementById('tariffFileInput');
            const statusMessage = document.getElementById('app1Status');
            const welcomeMessage = document.getElementById('app1Welcome');
            const loaderUI = document.getElementById('app1Loader');
            let currentFilter = 'All';

            // --- App 1 Functions ---
            async function loadTariffRules() {
                try {
                    statusMessage.textContent = 'æ­£åœ¨è¼‰å…¥é—œç¨…è¦å‰‡...';
                    statusMessage.classList.remove('text-red-700', 'text-green-700');
                    statusMessage.classList.add('text-blue-700');
                    
                    const response = await fetch('./tariff_rules.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (!Array.isArray(data)) {
                        throw new Error("JSON is not an array.");
                    }
                    tariffData = data;
                    statusMessage.textContent = `æˆåŠŸè¼‰å…¥é—œç¨…è¦å‰‡ï¼ŒåŒ…å« ${tariffData.length} ç­†è¦å‰‡ã€‚`;
                    statusMessage.classList.remove('text-blue-700');
                    statusMessage.classList.add('text-green-700');
                    loaderUI.classList.remove('bg-blue-50', 'border-blue-200');
                    loaderUI.classList.add('bg-green-50', 'border-green-200');
                    
                    searchInput.disabled = false;
                    searchInput.placeholder = "è¼¸å…¥ä¸­æ–‡/è‹±æ–‡é—œéµå­—æˆ–HTSUSç¢¼ (ä¾‹å¦‚: é‹¼ç®¡, pipe, 8407)...";
                    welcomeMessage.classList.add('hidden');
                    performSearch();
                } catch (error) {
                    statusMessage.textContent = `éŒ¯èª¤: ç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚(${error.message})`;
                    statusMessage.classList.remove('text-blue-700');
                    statusMessage.classList.add('text-red-700');
                    loaderUI.classList.remove('bg-blue-50', 'border-blue-200');
                    loaderUI.classList.add('bg-red-50', 'border-red-200');
                }
            }

            function handleFilterClick(e) {
                const text = e.currentTarget.textContent;
                if (text === 'å…¨éƒ¨') currentFilter = 'All';
                else if (text === 'é‹¼éµ') currentFilter = 'Steel';
                else if (text === 'é‹') currentFilter = 'Aluminum';
                updateFilterButtons(e.currentTarget);
                performSearch();
            }

            function handleHtsCodeClick(e) {
                if (e.target.classList.contains('hts-code-link')) {
                    const code = e.target.textContent.trim();
                    // Always switch to HTS tab and search via API
                    document.getElementById('tabHts').click(); 
                    const htsInput = document.getElementById('htsSearchInput');
                    const htsSearchBtn = document.getElementById('htsSearchBtn');
                    if (htsInput) {
                        htsInput.value = code;
                        htsSearchBtn.click(); // Trigger API search
                        htsInput.focus();
                    }
                }
            }

            function renderTariffInfo(tariffs) {
                if (!tariffs) {
                    tariffs = { sec232: { applicable: true, rate: '50%', note: 'æ­¤ç‚º8/18æ–°å¢ä¹‹è¡ç”Ÿå“é—œç¨… (é‡å°é‹¼/é‹å…§å®¹ç‰©)' } };
                }
                let tariffHtml = '<div class="mt-4 pt-4 border-t border-dashed border-gray-300 space-y-3">';
                tariffHtml += '<h4 class="text-sm font-bold text-gray-800">é—œç¨…é©ç”¨æ€§åˆ†æ</h4>';
                if (tariffs.sec232?.applicable) tariffHtml += `<div class="flex items-start"><div class="flex-shrink-0 w-24 text-xs font-semibold text-red-700 bg-red-100 px-2 py-1 rounded-full text-center">Section 232</div><div class="ml-4"><p class="text-sm font-bold text-red-700">${tariffs.sec232.rate}</p><p class="text-xs text-gray-500">${tariffs.sec232.note}</p></div></div>`;
                if (tariffs.sec301?.applicable) tariffHtml += `<div class="flex items-start"><div class="flex-shrink-0 w-24 text-xs font-semibold text-yellow-800 bg-yellow-100 px-2 py-1 rounded-full text-center">Section 301</div><div class="ml-4"><p class="text-sm font-bold text-yellow-800">${tariffs.sec301.rate}</p><p class="text-xs text-gray-500">${tariffs.sec301.note}</p></div></div>`;
                if (tariffs.ad_cvd?.applicable) tariffHtml += `<div class="flex items-start"><div class="flex-shrink-0 w-24 text-xs font-semibold text-purple-800 bg-purple-100 px-2 py-1 rounded-full text-center">AD / CVD</div><div class="ml-4"><p class="text-sm font-bold text-purple-800">é«˜åº¦é¢¨éšª</p><p class="text-xs text-gray-500">${tariffs.ad_cvd.note}</p></div></div>`;
                tariffHtml += '</div>';
                return tariffHtml;
            }

            function renderResults(results) {
                resultsContainer.innerHTML = ''; 
                if (tariffData.length === 0) {
                    welcomeMessage.classList.remove('hidden');
                    noResults.classList.add('hidden');
                    return;
                }
                welcomeMessage.classList.add('hidden');
                noResults.classList.toggle('hidden', results.length > 0);

                results.forEach((item, index) => {
                    const materialClass = item.material.includes('Steel') && item.material.includes('Aluminum') ? 'bg-indigo-100 text-indigo-800' : (item.material.includes('Steel') ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800');
                    const materialText = item.material.includes('Steel') && item.material.includes('Aluminum') ? 'é‹¼/é‹' : (item.material.includes('Steel') ? 'é‹¼éµ' : 'é‹');
                    let titleTag = item.isDerivative ? `<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full ml-2">8/18 æ–°å¢ 50%</span>` : '';
                    const detailsHtml = item.details?.map(detail => `<div class="py-2 px-4 flex items-start border-t border-gray-200 hover:bg-gray-50"><span class="hts-code-link text-sm font-mono text-gray-500 w-32 flex-shrink-0 cursor-pointer">${detail.hts || detail.sub_hts}</span><span class="text-sm text-gray-700">${detail.desc || ''}</span></div>`).join('') || '';
                    const tariffInfoHtml = renderTariffInfo(item.tariffs);
                    const card = `<div class="bg-white rounded-xl shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-lg"><div id="header-${index}" class="p-5 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"><div class="flex-grow"><div class="flex justify-between items-start gap-4"><h2 class="text-lg font-bold text-gray-900">${item.description} ${titleTag}</h2><span class="text-xs font-semibold px-2 py-1 rounded-full ${materialClass} flex-shrink-0 mt-1">${materialText}</span></div><p class="text-sm text-gray-500 mt-2">ç›¸é—œ HTSUS ç« ç¯€: ${item.chapter}</p></div><svg id="chevron-${index}" class="chevron w-6 h-6 text-gray-400 flex-shrink-0 ml-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div><div id="details-${index}" class="details-container px-5 pb-5">${detailsHtml}${tariffInfoHtml}</div></div>`;
                    resultsContainer.innerHTML += card;
                });

                results.forEach((_, index) => {
                    const header = document.getElementById(`header-${index}`);
                    if (header) {
                        header.addEventListener('click', () => {
                            document.getElementById(`details-${index}`).classList.toggle('open');
                            document.getElementById(`chevron-${index}`).classList.toggle('open');
                        });
                    }
                });
            }

            function performSearch() {
                if (tariffData.length === 0) {
                    renderResults([]);
                    return;
                }
                const searchTerm = searchInput.value.toLowerCase().trim();
                const filteredData = tariffData.filter(item => {
                    const matchesFilter = currentFilter === 'All' || item.material.includes(currentFilter);
                    if (!matchesFilter) return false;
                    const matchesMain = item.description.toLowerCase().includes(searchTerm) || item.chapter.toLowerCase().includes(searchTerm);
                    const matchesDetails = item.details?.some(d => (d.hts || d.sub_hts).toLowerCase().includes(searchTerm) || (d.desc || '').toLowerCase().includes(searchTerm));
                    return searchTerm === '' || matchesMain || matchesDetails;
                }).sort((a, b) => a.isDerivative - b.isDerivative);
                renderResults(filteredData);
            }

            function updateFilterButtons(activeButton) {
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white', 'shadow');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                activeButton.classList.add('bg-blue-500', 'text-white', 'shadow');
                activeButton.classList.remove('bg-white', 'text-gray-700');
            }

            // --- App 1 Initialization ---
            filterButtons.forEach(button => button.addEventListener('click', handleFilterClick));
            searchInput.addEventListener('input', performSearch);
            resultsContainer.addEventListener('click', handleHtsCodeClick);
            
            // è‡ªå‹•è¼‰å…¥ tariff_rules.json
            loadTariffRules();
            performSearch(); // Initial render (will show welcome message)
        }

        // --- APP 2: HTSUS API TARIFF DATABASE ---
        function initializeHtsApiApp() {
            // --- App 2 DOM ---
            const searchInput = document.getElementById('htsSearchInput');
            const searchBtn = document.getElementById('htsSearchBtn');
            const resultsContainer = document.getElementById('htsResultsContainer');
            const loader = document.getElementById('htsLoader');
            const welcomeMessage = document.getElementById('htsWelcomeMessage');
            const statusContainer = document.getElementById('htsStatusContainer');

            // --- 232æ¢æ¬¾å’Œç¨…ç‡è¨ˆç®—å‡½æ•¸ ---
            function check232Applicability(item, allItems) {
                const is232Related = item.footnotes?.some(f => 
                    f.value?.includes('subchapter III, chapter 99') ||
                    f.value?.includes('note 16') || // é‹¼éµ
                    f.value?.includes('note 19')    // é‹
                ) ?? false;

                if (!is232Related && item.statisticalSuffix) {
                    const parentHts = item.htsno.split('.').slice(0, -1).join('.');
                    const parentItem = allItems.find(i => i.htsno === parentHts);
                    if (parentItem) {
                        return check232Applicability(parentItem, allItems);
                    }
                }
                return is232Related;
            }

            function parseRate(rate) {
                if (!rate || rate === 'Free' || rate === '') return 0;
                const match = rate.match(/(\d+\.?\d*)/);
                return match ? parseFloat(match[0]) : 0;
            }

            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆ232æ¢æ¬¾
            function check232Applicability(item, allItems) {
                const is232Related = item.footnotes?.some(f => 
                    f.value?.includes('subchapter III, chapter 99') ||
                    f.value?.includes('note 16') || // é‹¼éµ
                    f.value?.includes('note 19')    // é‹
                ) ?? false;

                // å¦‚æœç•¶å‰é …ç›®ä¸ç›¸é—œï¼Œæª¢æŸ¥çˆ¶é …
                if (!is232Related && item.statisticalSuffix) {
                    const parentHts = item.htsno.split('.').slice(0, -1).join('.');
                    const parentItem = allItems.find(i => i.htsno === parentHts);
                    if (parentItem) {
                        return check232Applicability(parentItem, allItems);
                    }
                }
                return is232Related;
            }

            // åœ¨è¨»è…³ä¸­æŸ¥æ‰¾99ç« å¼•ç”¨å’Œ232æ¢æ¬¾ç›¸é—œèªªæ˜
            function findChapter99References(footnotes, column) {
                const refs = [];
                let has232Note = false;

                footnotes?.forEach(f => {
                    if (f.columns.includes(column)) {
                        // æª¢æŸ¥æ˜¯å¦åŒ…å«232æ¢æ¬¾ç›¸é—œèªªæ˜
                        if (f.value.includes('note 16') || 
                            f.value.includes('subchapter III, chapter 99')) {
                            has232Note = true;
                        }
                        // æŸ¥æ‰¾99ç« å¼•ç”¨
                        const matches = f.value.match(/99\d{2}\.\d{2}\.\d{2}/g) || [];
                        refs.push(...matches);
                    }
                });

                return {
                    refs: refs,
                    has232Note: has232Note
                };
            }

            function parseChapter99Rate(rateText) {
                if (!rateText) return 0;
                // å„ªå…ˆè™•ç†70%çš„æƒ…æ³
                if (rateText === '70%') {
                    console.log('Found exact 70% rate');
                    return 70;
                }
                if (rateText.includes('applicable subheading + 25%') || 
                    rateText.includes('The duty provided in the applicable subheading + 25%')) {
                    return 25;
                }
                const match = rateText.match(/(\d+\.?\d*)%/);
                return match ? parseFloat(match[1]) : 0;
            }

            function calculateTotalRates(item, allItems) {
                console.log('Calculating rates for:', item.htsno);
                if (!Array.isArray(allItems)) return { generalTotal: 0, otherTotal: 0 };
                
                const baseGeneralRate = parseRate(item.general);
                const baseOtherRate = parseRate(item.other);
                
                console.log('Base rates - General:', baseGeneralRate, 'Other:', baseOtherRate);
                
                // åˆ†åˆ¥ç²å–generalå’Œotheråˆ—çš„99ç« å¼•ç”¨
                const { refs: generalRefs, has232Note: hasGeneral232Note } = findChapter99References(item.footnotes, 'general');
                const { refs: otherRefs } = findChapter99References(item.footnotes, 'other');
                
                console.log('Found references - General:', generalRefs, '232 Note:', hasGeneral232Note);
                console.log('Found references - Other:', otherRefs);

                let additionalGeneralRate = 0;
                let additionalOtherRate = 0;

                // è™•ç†generalåˆ—çš„é¡å¤–ç¨…ç‡
                generalRefs.forEach(ref => {
                    console.log('Processing general ref:', ref);
                    const chapter99Item = allItems.find(i => i.htsno === ref);
                    console.log('Found chapter99 item:', chapter99Item);
                    if (chapter99Item?.general) {
                        // æª¢æŸ¥æ˜¯å¦åŒ…å«+25%çš„è¡¨è¿°
                        if (chapter99Item.general.includes('applicable subheading + 25%') ||
                            chapter99Item.general.includes('The duty provided in the applicable subheading + 25%')) {
                            console.log('Found +25% rate in general');
                            additionalGeneralRate = Math.max(additionalGeneralRate, 25); // ä½¿ç”¨æœ€é«˜çš„ç¨…ç‡
                        } else {
                            const rate = parseChapter99Rate(chapter99Item.general);
                            additionalGeneralRate = Math.max(additionalGeneralRate, rate);
                        }
                    }
                });

                // è™•ç†otheråˆ—çš„é¡å¤–ç¨…ç‡
                otherRefs.forEach(ref => {
                    console.log('Processing other ref:', ref);
                    const chapter99Item = allItems.find(i => i.htsno === ref);
                    console.log('Found chapter99 item for other:', chapter99Item);
                    if (chapter99Item?.other) {
                        const rate = parseChapter99Rate(chapter99Item.other);
                        console.log('Found additional other rate:', rate);
                        additionalOtherRate += rate;
                    }
                });

                console.log('Additional rates - General:', additionalGeneralRate, 'Other:', additionalOtherRate);

                // è¨ˆç®—æœ€çµ‚ç¨…ç‡
                let totalGeneralRate = baseGeneralRate;
                let totalOtherRate = baseOtherRate;

                if (hasGeneral232Note) {
                    // å°‹æ‰¾ 9903.91.01 (generalåˆ—25%ç¨…ç‡)
                    const general232Item = allItems.find(i => i.htsno === '9903.91.01');
                    if (general232Item) {
                        totalGeneralRate = 25;
                    }

                    // å°‹æ‰¾ 9903.90.09 (otheråˆ—70%ç¨…ç‡)
                    const other232Item = allItems.find(i => i.htsno === '9903.90.09');
                    if (other232Item) {
                        totalOtherRate = baseOtherRate + 70;
                    }
                }

                console.log('Final rates - General:', totalGeneralRate, 'Other:', totalOtherRate);

                console.log('Final rates - General:', totalGeneralRate, 'Other:', totalOtherRate);

                // è¿”å›è¨ˆç®—çµæœ
                return {
                    generalTotal: totalGeneralRate,
                    otherTotal: totalOtherRate,
                    hasAdditionalDuty: additionalGeneralRate > 0 || additionalOtherRate > 0
                };

                return {
                    generalTotal: baseGeneralRate + additionalGeneralRate,
                    otherTotal: baseOtherRate + additionalOtherRate
                };
            }

            function formatRate(rate) {
                return rate === 0 ? 'Free' : rate + '%';
            }

            // --- App 2 Functions ---
            function setLoading(isLoading) {
                if (isLoading) {
                    loader.classList.remove('hidden');
                    loader.classList.add('flex');
                    welcomeMessage.classList.add('hidden');
                    resultsContainer.innerHTML = '';
                } else {
                    loader.classList.add('hidden');
                    loader.classList.remove('flex');
                }
            }

            function esc(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
            
            function usitcLink(code){ return `https://hts.usitc.gov/search?query=${encodeURIComponent(code)}`; }

            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆ 232 æ¢æ¬¾
            function check232Applicability(item, allItems) {
                // æª¢æŸ¥ç•¶å‰é …ç›®çš„è¨»è…³
                const is232Related = item.footnotes?.some(f => 
                    f.value?.includes('subchapter III, chapter 99') ||
                    f.value?.includes('note 16') || // é‹¼éµ
                    f.value?.includes('note 19')    // é‹
                ) ?? false;

                // å¦‚æœç•¶å‰é …ç›®ä¸ç›¸é—œï¼Œæª¢æŸ¥çˆ¶é …
                if (!is232Related && item.statisticalSuffix) {
                    const parentHts = item.htsno.split('.').slice(0, -1).join('.');
                    const parentItem = allItems.find(i => i.htsno === parentHts);
                    if (parentItem) {
                        return check232Applicability(parentItem, allItems);
                    }
                }

                return is232Related;
            }

            // è§£æç¨…ç‡å­—ç¬¦ä¸²
            function parseRate(rate) {
                if (!rate || rate === 'Free' || rate === '') return 0;
                const match = rate.match(/(\d+\.?\d*)/);
                return match ? parseFloat(match[0]) : 0;
            }

            // æŸ¥æ‰¾é—œè¯çš„ 99 ç« ç¨…ç‡
            function findChapter99Rate(footnotes, allItems, rateType) {
                let additionalRate = 0;
                
                // åœ¨è¨»è…³ä¸­æŸ¥æ‰¾ 99 ç« å¼•ç”¨
                footnotes?.forEach(f => {
                    if (f.columns.includes(rateType)) {
                        const htsMatch = f.value.match(/99\d{2}\.\d{2}\.\d{2}/);
                        if (htsMatch && Array.isArray(allItems)) {  // ç¢ºä¿ allItems æ˜¯é™£åˆ—
                            const chapter99Item = allItems.find(item => item.htsno === htsMatch[0]);
                            if (chapter99Item) {
                                // è§£æ 99 ç« çš„ç¨…ç‡
                                if (chapter99Item[rateType]?.includes('+')) {
                                    const rateMatch = chapter99Item[rateType].match(/\+\s*(\d+\.?\d*)%/);
                                    if (rateMatch) {
                                        additionalRate += parseFloat(rateMatch[1]);
                                    }
                                } else {
                                    additionalRate += parseRate(chapter99Item[rateType]);
                                }
                            }
                        }
                    }
                });
                
                return additionalRate;
            }

            // è¨ˆç®—ç¸½ç¨…ç‡
            function calculateTotalRates(item, allItems) {
                // åŸºæœ¬ç¨…ç‡
                const baseGeneralRate = parseRate(item.general);
                const baseOtherRate = parseRate(item.other);

                // é¡å¤–ç¨…ç‡ï¼ˆä¾†è‡ª 99 ç« ï¼‰
                const additionalGeneralRate = findChapter99Rate(item.footnotes, allItems, 'general');
                const additionalOtherRate = findChapter99Rate(item.footnotes, allItems, 'other');

                return {
                    generalTotal: baseGeneralRate + additionalGeneralRate,
                    otherTotal: baseOtherRate + additionalOtherRate
                };
            }

            // æ ¼å¼åŒ–ç¨…ç‡é¡¯ç¤º
            function formatRate(rate) {
                return rate === 0 ? 'Free' : rate + '%';
            }

            function renderResults(items) {
                resultsContainer.innerHTML = '';
                welcomeMessage.classList.add('hidden');

                if (!items || items.length === 0) {
                    resultsContainer.innerHTML = `<div class="text-center py-10"><p class="text-lg text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„çµæœï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—ã€‚</p></div>`;
                    return;
                }

                const fragment = document.createDocumentFragment();
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-gray-200 rounded-lg p-4 transition-all hover:bg-gray-50 hover:border-blue-300';
                    const indentPx = (Number(item.indent) || 0) * 20;
                    
                    // æª¢æŸ¥232æ¢æ¬¾ç›¸é—œæ€§å’Œè¨ˆç®—ç¸½ç¨…ç‡
                    const itemIs232Related = check232Applicability(item, items);
                    const { generalTotal: itemGeneralTotal, otherTotal: itemOtherTotal } = calculateTotalRates(item, items);
                    
                    // Highlight search term
                    const searchTerm = searchInput.value.trim();
                    let descriptionHtml = esc(item.description || '');
                    if (searchTerm) {
                         const regex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                         descriptionHtml = descriptionHtml.replace(regex, `<mark class="bg-yellow-200 px-1 rounded">${searchTerm}</mark>`);
                    }

                    // æª¢æŸ¥æ˜¯å¦ç¬¦åˆ232æ¢æ¬¾ä¸¦è¨ˆç®—ç¨…ç‡
                    const is232Related = check232Applicability(item, window.currentSearchResults);
                    const { generalTotal, otherTotal } = calculateTotalRates(item, window.currentSearchResults);
                    
                    // æ ¼å¼åŒ–ç¨…ç‡é¡¯ç¤º
                    function formatRate(rate) {
                        return rate === 0 ? 'Free' : rate + '%';
                    }

                    // è™•ç†ç¨…ç‡ç¹¼æ‰¿
                    function findParentRate(items, currentItem) {
                        if (currentItem.general && currentItem.general !== '') {
                            return currentItem.general;
                        }
                        
                        // æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„çˆ¶é …
                        const currentIndent = parseInt(currentItem.indent || '0');
                        const parentItems = items.filter(i => 
                            i.htsno === currentItem.htsno.split('.').slice(0, -1).join('.') && 
                            parseInt(i.indent || '0') < currentIndent
                        );

                        // æŒ‰ç¸®æ’å±¤ç´šæ’åºï¼Œæ‰¾åˆ°æœ€è¿‘çš„çˆ¶é …
                        const parent = parentItems.sort((a, b) => 
                            parseInt(b.indent || '0') - parseInt(a.indent || '0')
                        )[0];

                        return parent ? (parent.general || '') : '';
                    }

                    // ç²å–å¯¦éš›ç¨…ç‡
                    const actualRate = item.general || findParentRate(window.currentSearchResults || [], item);

                    // è™•ç†è¨»è…³
                    const footnotes = item.footnotes?.map((f, footnoteIndex) => {
                        const is232Related = f.value?.includes('232') || 
                                          f.value?.includes('9903.80') || 
                                          f.value?.includes('9903.85');
                        
                        // å°‹æ‰¾HTSUSä»£ç¢¼
                        const htsMatches = f.value.match(/99\d{2}\.\d{2}\.\d{2}/g) || [];
                        let processedValue = f.value;
                        let lastIndex = 0;
                        let parts = [];
                        
                        // æ›´ç²¾ç¢ºçš„æ›¿æ›HTSUSä»£ç¢¼
                        htsMatches.forEach((code, codeIndex) => {
                            const codeIndex2 = f.value.indexOf(code, lastIndex);
                            if (codeIndex2 !== -1) {
                                // æ·»åŠ ä»£ç¢¼å‰çš„æ–‡å­—
                                if (codeIndex2 > lastIndex) {
                                    parts.push(esc(f.value.substring(lastIndex, codeIndex2)));
                                }
                                
                                // ç”Ÿæˆå”¯ä¸€ID
                                const uniqueId = `footnote-${item.htsno.replace(/\./g, '-')}-${footnoteIndex}-${codeIndex}`;
                                
                                // æ·»åŠ é€£çµ
                                parts.push(`<a href="#" class="text-blue-600 hover:text-blue-800 footnote-link" data-hts="${code}" data-detail-id="${uniqueId}">${code}</a>`);
                                
                                lastIndex = codeIndex2 + code.length;
                            }
                        });
                        
                        // æ·»åŠ å‰©é¤˜çš„æ–‡å­—
                        if (lastIndex < f.value.length) {
                            parts.push(esc(f.value.substring(lastIndex)));
                        }
                        
                        processedValue = parts.join('');

                        return `
                            <div class="footnote-container relative">
                                <div class="text-xs ${is232Related ? 'text-red-600 font-medium' : 'text-gray-600'} mt-1">
                                    <span class="font-medium">${esc(f.columns.join(', '))}:</span> 
                                    ${is232Related ? 'ğŸ”” ' : ''}${processedValue}
                                </div>
                                ${htsMatches.map((code, codeIndex) => `
                                    <div id="footnote-${item.htsno.replace(/\./g, '-')}-${footnoteIndex}-${codeIndex}"
                                         class="footnote-details mt-2 ml-4 hidden">
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }).join('') || '';

                    // è™•ç†å–®ä½
                    const units = item.units?.length 
                        ? `<div class="text-sm text-gray-600 mt-2">å–®ä½: ${esc(item.units.join(', '))}</div>` 
                        : '';

                    card.innerHTML = `
                        <div style="padding-left:${indentPx}px;">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <p class="font-semibold text-lg">
                                            <a class="text-blue-600 hover:text-blue-800" href="${usitcLink(item.htsno)}" target="_blank" rel="noopener noreferrer">
                                                ${esc(item.htsno)}
                                                ${item.statisticalSuffix ? `<span class="text-gray-500 text-sm">.${esc(item.statisticalSuffix)}</span>` : ''}
                                            </a>
                                        </p>
                                        ${check232Applicability(item, window.currentSearchResults) ? `
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                232æ¢æ¬¾ç›¸é—œé …ç›®
                                            </span>
                                        ` : ''}
                                    </div>
                                    <p class="text-gray-800 mt-1">${descriptionHtml}</p>
                                </div>
                                <div class="text-xs bg-gray-100 px-2 py-1 rounded whitespace-nowrap">
                                    ç¸®æ’ç­‰ç´š: ${esc(item.indent || '0')}
                                </div>
                            </div>

                            ${units}

                            <div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                    <div>
                                        <p class="font-medium text-gray-500">ç¬¬ä¸€æ¬„ (æ™®é€š)</p>
                                        <p class="text-gray-700">
                                            ${esc(actualRate || 'â€”')}
                                            ${item.general === '' ? '<span class="text-xs text-gray-500">(ç¹¼æ‰¿è‡ªçˆ¶é …)</span>' : ''}
                                            ${(itemIs232Related && itemGeneralTotal > 0) ? 
                                                `<span class="text-xs text-red-600 ml-2">
                                                    â†’ ${formatRate(itemGeneralTotal)} 
                                                    (å«232æ¢æ¬¾)
                                                </span>` 
                                                : ''}
                                        </p>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-500">ç¬¬ä¸€æ¬„ (ç‰¹æ®Š)</p>
                                        <p class="text-gray-700">${esc(item.special ?? 'â€”')}</p>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-500">ç¬¬äºŒæ¬„</p>
                                        <p class="text-gray-700">
                                            ${esc(item.other ?? item.col2 ?? 'â€”')}
                                            ${(itemIs232Related && itemOtherTotal > parseRate(item.other)) ? 
                                                `<span class="text-xs text-red-600 ml-2">
                                                    â†’ ${formatRate(itemOtherTotal)} 
                                                    (å«232æ¢æ¬¾)
                                                </span>` 
                                                : ''}
                                        </p>
                                    </div>
                                </div>

                                ${item.quotaQuantity ? 
                                    `<div class="mt-2 text-sm">
                                        <p class="font-medium text-gray-500">é…é¡æ•¸é‡</p>
                                        <p class="text-gray-700">${esc(item.quotaQuantity)}</p>
                                    </div>` : ''
                                }

                                ${item.additionalDuties ? 
                                    `<div class="mt-2 text-sm">
                                        <p class="font-medium text-gray-500">é¡å¤–é—œç¨…</p>
                                        <p class="text-gray-700">${esc(item.additionalDuties)}</p>
                                    </div>` : ''
                                }

                                ${footnotes ? 
                                    `<div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                                        <p class="font-medium text-gray-500 text-sm mb-1">è¨»è…³èªªæ˜</p>
                                        ${footnotes}
                                    </div>` : ''
                                }
                            </div>
                        </div>`;
                    fragment.appendChild(card);
                });
                resultsContainer.appendChild(fragment);
            }

            async function performApiSearch() {
                const searchTerm = searchInput.value.trim();
                const show232Only = document.getElementById('show232Only').checked;

                if (searchTerm.length < 2 && !show232Only) {
                    resultsContainer.innerHTML = `<div class="text-center py-10"><p class="text-lg text-gray-500">è«‹è¼¸å…¥è‡³å°‘ 2 å€‹å­—å…ƒä»¥é€²è¡Œæœå°‹${show232Only ? 'ï¼Œæˆ–é¸æ“‡åƒ…é¡¯ç¤º 232 æ¢æ¬¾ç›¸é—œé …ç›®' : ''}ã€‚</p></div>`;
                    return;
                }

                setLoading(true);

                // *** MODIFIED FOR NETLIFY PROXY ***
                const apiUrl = `/.netlify/functions/hts-proxy?keyword=${encodeURIComponent(searchTerm)}`;

                try {
                    // We no longer need the proxy URL for the fetch call itself
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                         const errorText = await response.text();
                        throw new Error(`ä»£ç†è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}. ${errorText}`);
                    }
                    const data = await response.json();
                    // ç¢ºä¿ data.results æ˜¯é™£åˆ—
                    if (!Array.isArray(data.results)) {
                        throw new Error('API å›å‚³çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
                    }
                    
                    // å„²å­˜æ‰€æœ‰çµæœ
                    window.currentSearchResults = data.results;
                    renderResults(data.results);
                } catch (error) {
                    console.error("API Search Error:", error);
                    resultsContainer.innerHTML = `<div class="text-center py-10"><p class="text-lg text-red-600">æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤</p><p class="text-sm text-gray-500 mt-1">${error.message}</p></div>`;
                } finally {
                    setLoading(false);
                }
            }

            // --- App 2 Initialization ---
            searchBtn.addEventListener('click', performApiSearch);
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performApiSearch();
                }
            });

            // è™•ç†è¨»è…³ä¸­HTSUSä»£ç¢¼çš„é»æ“Šäº‹ä»¶
            let lastClickedLink = null;
            let clickTimer = null;

            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('footnote-link')) {
                    e.preventDefault();
                    const htsCode = e.target.dataset.hts;
                    const detailId = e.target.dataset.detailId;
                    const detailsContainer = document.getElementById(detailId);
                    
                    if (!detailsContainer) return;

                    // é—œé–‰ä¹‹å‰æ‰“é–‹çš„å®¹å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    if (lastClickedLink && lastClickedLink !== e.target) {
                        const lastDetailId = lastClickedLink.dataset.detailId;
                        const lastContainer = document.getElementById(lastDetailId);
                        if (lastContainer) {
                            lastContainer.classList.add('hidden');
                        }
                    }
                    
                    // æ›´æ–°æœ€å¾Œé»æ“Šçš„é€£çµ
                    lastClickedLink = e.target;

                    // åˆ‡æ›ç•¶å‰å®¹å™¨çš„é¡¯ç¤ºç‹€æ…‹
                    if (detailsContainer.classList.contains('hidden')) {
                        detailsContainer.classList.remove('hidden');
                        detailsContainer.innerHTML = '<div class="text-gray-500 text-sm py-2">æœå°‹ä¸­...</div>';
                        
                        try {
                            const response = await fetch(`/.netlify/functions/hts-proxy?keyword=${encodeURIComponent(htsCode)}`);
                            if (!response.ok) throw new Error('æœå°‹å¤±æ•—');
                            
                            const data = await response.json();
                            if (!data.results?.length) throw new Error('æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Š');
                            
                            const result = data.results[0];
                            detailsContainer.innerHTML = `
                                <div class="bg-gray-50 rounded-lg p-3 text-sm border border-gray-200">
                                    <div class="flex justify-between items-start">
                                        <div class="font-medium text-gray-900">${result.description || 'ç„¡æè¿°'}</div>
                                        <button class="text-gray-400 hover:text-gray-600 close-details" 
                                                data-hts="${htsCode}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="mt-2 space-y-1 text-gray-600">
                                        ${result.general ? `<div>ç¬¬ä¸€æ¬„ (æ™®é€š): ${result.general}</div>` : ''}
                                        ${result.special ? `<div>ç¬¬ä¸€æ¬„ (ç‰¹æ®Š): ${result.special}</div>` : ''}
                                        ${result.other ? `<div>ç¬¬äºŒæ¬„: ${result.other}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            detailsContainer.innerHTML = `
                                <div class="text-red-500 text-sm py-2 bg-red-50 rounded-lg px-3">
                                    ${error.message}
                                </div>
                            `;
                        }
                    } else {
                        detailsContainer.classList.add('hidden');
                    }
                }

                // è™•ç†é—œé–‰æŒ‰éˆ•çš„é»æ“Š
                if (e.target.closest('.close-details')) {
                    const htsCode = e.target.closest('.close-details').dataset.hts;
                    const detailsContainer = document.getElementById(`footnote-details-${htsCode.replace(/\./g, '-')}`);
                    if (detailsContainer) {
                        detailsContainer.classList.add('hidden');
                    }
                }
            });
        }


        // --- MAIN APP INITIALIZATION ---
        function initializeApp() {
            tabs.forEach(tab => tab.addEventListener('click', (e) => {
                tabs.forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                const activeTab = e.currentTarget;
                activeTab.classList.add('active');
                activeTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                Object.values(contents).forEach(content => content.style.display = 'none');
                const contentId = activeTab.id.replace('tab', '').toLowerCase() + 'Content';
                contents[contentId].style.display = 'block';
            }));
            
            initializeApp1();
            initializeHtsApiApp(); // Changed from initializeHtsAppV2
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>
